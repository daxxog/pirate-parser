/* PirateParser
 * parse torrents_mini.csv.gz
 * (c) 2014 David (daXXog) Volm ><> + + + <><
 * Released under Apache License, Version 2.0:
 * http://www.apache.org/licenses/LICENSE-2.0.html  
 */ !function(t,e){"object"==typeof exports?module.exports=e():"function"==typeof define&&define.amd?define(e):t.PirateParser=e()}(this,function(){var t,e=require("fstream"),r=require("child_process").spawn,i=require("util").inherits,n=require("events").EventEmitter,s=(require("fs").readFileSync,require("switch-factory")),o=require("string");return t=function(i){var n,s=this;n="string"!=typeof i?"torrents_mini.csv.gz":i,this.bin=[],this.headers=[],this.fs=e.Reader(n),this.gz=r("gzip",["-dc"]),this.fs.pipe(this.gz.stdin),this.gz.stdout.on("data",function(e){var r,i=e.toString(),n=i.toString().split("\n");n.forEach(function(e){r=s.parse(e),t.isParsed(r)?s.emit("torrent",r):-1!==r&&s.bin.push(e)}),s.bin.length>10&&s.merge()}),this.gz.on("close",function(){for(;s.bin.length>1;)s.merge();s.emit("end")})},i(t,n),t.prototype.merge=function(){var e=[];for(e.push(this.bin.shift()),e.push(this.bin.shift()),parsed=this.parse(e.join(""));!t.isParsed(parsed);){if(e.push(this.bin.shift()),0===this.bin.length)throw"parse error\n\n"+e.join("")+"\n\n"+JSON.stringify(e);parsed=this.parse(e.join(""))}this.emit("torrent",parsed)},t.prototype.parse=function(t){var e,r=this,i={"|":!1,'"':!1},n=!1,s=t;return 0!==s.indexOf('"')&&(1===this.headers.length&&(s=this.headers.shift()+s),-1===s.indexOf("|")&&(this.headers.push(s),n=-1)),n===!1&&(e=this.sanitize(s).split("").map(function(t){switch(r._finder(t)&&(i[t]=!i[t]),t){case"|":return i['"']===!0?r.CHAR_FIX:t;case r.CHAR_FIX:throw"CHAR_FIX error\n\n"+s;default:return t}}).join("").split("|").map(function(t){return i['"']===!0&&(n=!0),t.split("").map(function(t){switch(r._finder(t)&&(i[t]=!i[t]),t){case r.CHAR_FIX:return i['"']===!0?"|":t;case r.ESCAPE_FIX:return i['"']===!0?'""':t;default:return t}}).join("")})),n?n:e},t.prototype.sanitize=function(t){return o(t).replaceAll('\\"|',this.SEP_FIX).replaceAll('\\"',this.ESCAPE_FIX).s},t.isParsed=function(t){return Array.isArray(t)&&7===t.length},t.prototype._finder=s.is(["|",'"']),t.prototype.CHAR_FIX="",t.prototype.ESCAPE_FIX="\f",t.prototype.SEP_FIX=t.prototype.ESCAPE_FIX+'"|',t});